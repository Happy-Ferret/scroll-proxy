var SUtil,ScrollProxy,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};SUtil=require("./SUtil"),module.exports=ScrollProxy=function(){function a(a){if(null==a&&(a=document),a===document&&(a=a.body),a===window&&(a=a.document.body),!(a instanceof HTMLElement))throw new Error("Could not attach to a valid anchor");return this._target=a,this._events=[],this.register(),this._updateViewportInfo(),this}return a.active=!1,a._targetList=[],a.SCROLL="scroll",a.OFFSET_X="offsetX",a.OFFSET_Y="offsetY",a.TOP="top",a.BOTTOM="bottom",a.LEFT="left",a.RIGHT="right",a.VISIBLE="visible",a.INVISIBLE="invisible",a.DISABLE_HOVER="disable-hover",a.prototype._targetX="scrollLeft",a.prototype._targetY="scrollTop",a.prototype._target=null,a.prototype._events=[],a.prototype._scrollDelay=250,a.prototype._hoverDelay=250,a.prototype._hoverTimeout=null,a.prototype.x=0,a.prototype.y=0,a.prototype.width=0,a.prototype.height=0,a.prototype.scrollWidth=0,a.prototype.scrollHeight=0,a.prototype.scrollData={},a._handleScroll=function(b){var c,d;return c=a._targetList.length,0===c?null:(d=b.target.body||b.target,a._getElement(d).proxy._performScroll(b))},a._getElement=function(b){var c,d,e,f;for(f=a._targetList,d=0,e=f.length;e>d;d++)if(c=f[d],null!=c&&c.target===b)return c;return null},a.activate=function(){return a.active||(window.addEventListener(a.SCROLL,a._handleScroll,!0),a.active=!0),a.active},a.deactivate=function(){return window.removeEventListener(a.SCROLL,a._handleScroll,!0),a.active=!1},a.clean=function(){var b,c,d,e,f;for(e=a._targetList,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(b.proxy.unregister());return f},a.prototype._updateViewportInfo=function(){return this.x=this._target[this._targetX],this.y=this._target[this._targetY],this.width=this._target.offsetWidth,this.height=this._target.offsetHeight,this.scrollWidth=this._target.scrollWidth,this.scrollHeight=this._target.scrollHeight,null},a.prototype._checkElement=function(a){if(indexOf.call(this._target.children,a)<0)throw new Error("Element must be child of the scroll element");return null},a.prototype._removeEvent=function(a){var b,c,d,e,f,g,h,i,j;for(i=this._events,c=e=0,g=i.length;g>e;c=++e)if(d=i[c],a===d){window.clearTimeout(a.timeout),delete a.fn,delete this._events[c];break}for(b=[],j=this._events,f=0,h=j.length;h>f;f++)d=j[f],null!=d&&b.push(d);return this._events=b},a.prototype._isRectVisible=function(a){var b,c;return this._updateViewportInfo(),b=this.x<a.x+a.w&&this.x>a.x-this.width,c=this.y<a.y+a.h&&this.y>a.y-this.height,b&&c},a.prototype._performScroll=function(a){var b,c,d,e,f;if(d=this._events.length,0===d)return null;for(this.scrollData=a,f=this._events,c=0,e=f.length;e>c;c++)b=f[c],b.fn.call(this,b);return this._target},a.prototype._throttleScroll=function(a,b){var c;return c=!1,function(d){return function(e){return c?void 0:(c=!0,e.timeout=window.setTimeout(function(){return c=!1,SUtil.reportChange(a,d,d.scrollData)},null!=b?b:d.getScrollDelay()))}}(this)},a.prototype._createEvent=function(a,b,c){var d;return d=this._throttleScroll(b,c),this._events.push({type:a,fn:d.bind(this),timeout:null})},a.prototype._createScrollEvent=function(a,b,c){return this._createEvent(a,function(a){return function(){return a._updateViewportInfo(),SUtil.reportChange(b,a,a.scrollData)}}(this),c)},a.prototype._createOffsetEvent=function(b,c,d){return null==d&&(d=0),b===a.OFFSET_X?this._createEvent(b,function(a){return function(){return a.x===a._target[a._targetX]?a._updateViewportInfo():(a._updateViewportInfo(),SUtil.isPositiveNumber(d)&&a.x<d||SUtil.isNegativeNumber(d)&&a.x>Math.abs(d)?void 0:SUtil.reportChange(c,a,a.scrollData))}}(this)):this._createEvent(b,function(a){return function(){return a.y===a._target[a._targetY]?a._updateViewportInfo():(a._updateViewportInfo(),SUtil.isPositiveNumber(d)&&a.y<d||SUtil.isNegativeNumber(d)&&a.y>Math.abs(d)?void 0:SUtil.reportChange(c,a,a.scrollData))}}(this))},a.prototype._createHorizontalBoundScrollEvent=function(b,c,d){return null==d&&(d=0),b===a.LEFT?this._createScrollEvent(b,function(a){return function(){return a.x<=Math.abs(d)?SUtil.reportChange(c,a,a.scrollData):void 0}}(this),0):this._createScrollEvent(b,function(a){return function(){return a.scrollWidth-a.x-a.width<=Math.abs(d)?SUtil.reportChange(c,a,a.scrollData):void 0}}(this),0)},a.prototype._createVerticalBoundScrollEvent=function(b,c,d){return null==d&&(d=0),b===a.TOP?this._createScrollEvent(b,function(a){return function(){return a.y<=Math.abs(d)?SUtil.reportChange(c,a,a.scrollData):void 0}}(this),0):this._createScrollEvent(b,function(a){return function(){return a.scrollHeight-a.y-a.height<=Math.abs(d)?SUtil.reportChange(c,a,a.scrollData):void 0}}(this),0)},a.prototype._createVisibilityScrollEvent=function(b,c,d){return this._checkElement(d),b===a.VISIBLE?this._createScrollEvent(b,function(a){return function(){return a.isElementVisible(d)?SUtil.reportChange(c,a,a.scrollData):void 0}}(this)):this._createScrollEvent(b,function(a){return function(){return a.isElementVisible(d)?void 0:SUtil.reportChange(c,a,a.scrollData)}}(this))},a.prototype.setScrollDelay=function(a){return SUtil.isPositiveNumber(a)&&(this._scrollDelay=Math.round(a)),this},a.prototype.getScrollDelay=function(){return this._scrollDelay},a.prototype.setHoverDelay=function(a){return SUtil.isPositiveNumber(a)&&(this._hoverDelay=Math.round(a)),this},a.prototype.getHoverDelay=function(){return this._hoverDelay},a.prototype.getTarget=function(){return this._target},a.prototype.getRect=function(a){return{x:a.offsetLeft,y:a.offsetTop,w:a.getBoundingClientRect().width,h:a.getBoundingClientRect().height}},a.prototype.on=function(b,c,d){if(!SUtil.isValidEventName(b))return this;if(!SUtil.isFunction(c))return this;switch(b){case a.SCROLL:this._createScrollEvent(b,c);break;case a.OFFSET_X:case a.OFFSET_Y:this._createOffsetEvent(b,c,d);break;case a.TOP:case a.BOTTOM:this._createVerticalBoundScrollEvent(b,c,d);break;case a.LEFT:case a.RIGHT:this._createHorizontalBoundScrollEvent(b,c,d);break;case a.VISIBLE:case a.INVISIBLE:this._createVisibilityScrollEvent(b,c,d)}return this},a.prototype.once=function(a,b,c){var d;return d=function(c){return function(){return SUtil.reportChange(b,c,c.scrollData),c.off(a)}}(this),this.on(a,d,c)},a.prototype.off=function(a){var b,c,d,e,f;if(!SUtil.isValidEventName(a))return this;for(f=this._events,c=d=0,e=f.length;e>d;c=++d)b=f[c],null!=b&&a===b.type&&this._removeEvent(b);return this},a.prototype.register=function(){var b;if(b=a._getElement(this._target),null!=b)throw new Error("Assign one proxy per target");return a._targetList.push({target:this._target,proxy:this}),a.activate(),this},a.prototype.unregister=function(){var b,c,d,e,f;for(f=a._targetList,b=d=0,e=f.length;e>d;b=++d)c=f[b],null!=c&&c.target===this._target&&SUtil.removeItemFromArray(a._targetList,b);return 0===a._targetList.length&&a.deactivate(),this},a.prototype.isElementVisible=function(a){return this._checkElement(a),this._isRectVisible(this.getRect(a))},a.prototype.disableHoverOnScroll=function(){return this._createScrollEvent(a.DISABLE_HOVER,function(a){return function(){return window.clearTimeout(a._hoverTimeout),a._target.style.pointerEvents="none",a._hoverTimeout=window.setTimeout(function(){return a._target.style.pointerEvents="auto"},a.getHoverDelay())}}(this),0),this},a.prototype.enableHoverOnScroll=function(){return this.off(a.DISABLE_HOVER),this._target.style.pointerEvents="auto",this},a}();